<!-- This is file for call (init) chatbot -->
<!DOCTYPE html>
<script>
  // const guid = "9e2db3cf-238b-4182-980e-725e16699331";
  // const url_string = `http://zustand-chatbot.s3-website.eu-west-2.amazonaws.com`;
  // const guid = "FE10595F-12C4-4C59-8FAA-055BB0FCB1A6"; // 'prod' guid
  const guid = "f466faec-ea83-4122-8c23-458ab21e96be";
  const url_string = `http://loop-chat-bot.s3-website.eu-west-2.amazonaws.com`;
  const iframeID = "chat-iframe";

  let chatBotStyle;
  let chatBotToken;

  const appendChatBot = (style, token) => {
    chatBotStyle = style;
    chatBotToken = token;
    const ifrm = document.createElement("iframe");

    ifrm.setAttribute("src", url_string);
    ifrm.setAttribute("id", iframeID);
    ifrm.setAttribute("width", "370px");
    ifrm.setAttribute(
      "sandbox",
      "allow-popups allow-popups-to-escape-sandbox allow-scripts allow-same-origin"
    );

    ifrm.sandbox.add(
      "allow-popups",
      "allow-popups-to-escape-sandbox",
      "allow-scripts",
      "allow-same-origin"
    );
    ifrm.style.cssText = `position: fixed;right: 10px; bottom: 10px; z-index: 2; transition: all 0.5s ease-in-out;border: none;`;

    document.body.appendChild(ifrm);

    ifrm.addEventListener("load", () => {
      ifrm.contentWindow.postMessage({ guid, style, token }, ifrm.src);
    });
    ifrm.onerror = () => refreshToken();
  };

  const refreshToken = async (callback) => {
    try {
      const refreshRes = await fetch(
        "https://qa-integrations.loopworks.com/api/chatbot/token",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ ChatbotGuid: guid.trim() }),
        }
      );

      const data = await refreshRes.clone().json();

      if (data?.errors) {
        console.log(data.errors[0]);
        return Promise.reject(data.errors[0]);
      } else {
        callback && callback(data);
        return Promise.resolve(data);
      }
    } catch (error) {
      return Promise.reject(error);
    }
  };

  const getChatBotStyle = async (token) => {
    fetch(
      "https://qa-integrations.loopworks.com/api/chatbot/style?ChatBotGuid=" +
        guid
    )
      .then((response) => response.json())
      .then((data) => {
        if (data.statusCode === 413) {
          refreshToken(getChatBotStyle);
        } else {
          appendChatBot(JSON.parse(data), token);
        }
      })
      .catch((error) => Promise.reject(error));
  };

  refreshToken(getChatBotStyle);

  function onMessage(event) {
    console.log(
      "%cEVENT",
      "background-color: darkblue; color: white; font-style: italic; border: 5px solid hotpink; font-size: 1em; padding: 5px;",
      event
    );
    if (url_string.indexOf(event.origin) !== -1 && event.data.event_id) {
      const chatbotIframe = document.getElementById(iframeID);

      switch (event.data.event_id) {
        case "refresh_token":
          refreshToken(event.data.callback)
            .then((data) => {
              if (data) {
                if (chatbotIframe) {
                  chatbotIframe.contentWindow.postMessage(
                    { token: data },
                    url_string
                  );
                }
              }
            })
            .catch(() => console.log("_ E R R O R _"));

          break;
        case "refresh_chatbot":
          console.log(
            "%cREFRESH CHATBOT",
            "background-color: darkblue; color: white; font-style: italic; border: 5px solid hotpink; font-size: 1em; padding: 5px;"
          );
          chatbotIframe?.remove();
          refreshToken(getChatBotStyle);
          break;
        case "iframe_height":
          if (chatbotIframe && "isSelectedOption" in event.data) {
            chatbotIframe.style.height = event.data.isSelectedOption
              ? "601px"
              : "135px";
          }
          break;
        // this case for Safari (iframe.onload didn't work)
        case "get_chatbot_data":
          chatbotIframe.contentWindow.postMessage(
            { guid, style: chatBotStyle, token: chatBotToken },
            url_string
          );
          break;
        default:
          break;
      }
    }
  }

  if (window.addEventListener) {
    window.addEventListener("message", onMessage);
  } else {
    window.attachEvent("onmessage", onMessage); // IE8
  }
</script>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat-Bot</title>
  </head>
  <body>
    <div id="root">CHATBOT</div>
  </body>
</html>
